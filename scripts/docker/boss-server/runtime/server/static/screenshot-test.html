<!doctype html>
<html class="mdc-typography">
  <head>
    <meta charset="utf-8">
    <title>Screenshot Test - MDC-Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.css">
    <link rel="stylesheet" href="node_modules/material-components-web/dist/material-components-web.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
      /* apply a natural box layout model to all elements, but allowing components to change */
      html {
        box-sizing: border-box;
      }
      *, *:before, *:after {
        box-sizing: inherit;
      }

      html,
      body {
        height: 100%;
      }

      .page {
        /* Hack to force the margin-top of .mdc-toolbar-fixed-adjust to collapse */
        border-top: 1px solid transparent;
      }

      .main {
        padding: 24px;
      }

      .top-section {
        display: flex;
      }

      .progress-section {
        margin-left: 48px;
      }

      #pr-number {
        width: 8em;
      }

      .output {
        margin: 24px 0;
      }

      textarea {
        width: 100%;
        height: 15em;
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: small;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <header class="mdc-toolbar mdc-toolbar--fixed">
      <div class="mdc-toolbar__row">
        <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
          <span class="mdc-toolbar__title catalog-title">Screenshot Test</span>
        </section>
      </div>
    </header>

    <div class="page">
      <div class="mdc-toolbar-fixed-adjust"></div>

      <main class="main">
        <section>
          <div class="top-section">
            <div class="form-wrapper">
              <h1 class="mdc-typography--title">GitHub Pull Request</h1>
              <form action="/github/pr">
                <div class="pr-form-field">
                  <div class="mdc-textfield mdc-textfield--box">
                    <input type="number"
                           min="1"
                           max="99999"
                           step="1"
                           size="6"
                           class="mdc-textfield__input"
                           aria-controls="name-validation-message"
                           id="pr-number"
                           name="pr_number"
                           value="1469"
                           required
                           autofocus>
                    <label for="pr-number" class="mdc-textfield__label">PR #</label>
                    <div class="mdc-textfield__bottom-line"></div>
                  </div>
                  <p class="mdc-textfield-helptext mdc-textfield-helptext--validation-msg"
                     id="name-validation-msg">
                    1-99999 required
                  </p>
                </div>
                <button type="submit" id="submit" class="mdc-button mdc-button--stroked">Start Screenshot Tests</button>
              </form>
            </div>

            <div class="progress-section">
              <h1 class="mdc-typography--title">Progress</h1>

              <p>Node Module Installation</p>
              <div role="progressbar" class="mdc-linear-progress" id="node-module-progress">
                <div class="mdc-linear-progress__buffering-dots"></div>
                <div class="mdc-linear-progress__buffer"></div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                  <span class="mdc-linear-progress__bar-inner"></span>
                </div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                  <span class="mdc-linear-progress__bar-inner"></span>
                </div>
              </div>

              <p>Demo Server Build</p>
              <div role="progressbar" class="mdc-linear-progress" id="demo-server-build-progress">
                <div class="mdc-linear-progress__buffering-dots"></div>
                <div class="mdc-linear-progress__buffer"></div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                  <span class="mdc-linear-progress__bar-inner"></span>
                </div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                  <span class="mdc-linear-progress__bar-inner"></span>
                </div>
              </div>

              <p>Screenshot Tests</p>
              <div role="progressbar" class="mdc-linear-progress" id="screenshot-test-progress">
                <div class="mdc-linear-progress__buffering-dots"></div>
                <div class="mdc-linear-progress__buffer"></div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                  <span class="mdc-linear-progress__bar-inner"></span>
                </div>
                <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                  <span class="mdc-linear-progress__bar-inner"></span>
                </div>
              </div>
            </div>
          </div>

          <div class="output">
            <h2 class="mdc-typography--subheading2">stdout</h2>
            <textarea readonly id="stdout"></textarea>
          </div>

          <div class="output">
            <h2 class="mdc-typography--subheading2">stderr</h2>
            <textarea readonly id="stderr"></textarea>
          </div>

          <div class="output">
            <h2 class="mdc-typography--subheading2">other</h2>
            <textarea readonly id="other"></textarea>
          </div>
        </section>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <script src="node_modules/material-components-web/dist/material-components-web.js"></script>
    <script>
      (() => {
        $('.mdc-button').each((i, button) => mdc.ripple.MDCRipple.attachTo(button));
        $('.mdc-textfield').each((i, textField) => mdc.textfield.MDCTextfield.attachTo(textField));

        const installNodeModuleProgress = mdc.linearProgress.MDCLinearProgress.attachTo($('#node-module-progress')[0]);
        const demoServerBuildProgress = mdc.linearProgress.MDCLinearProgress.attachTo($('#demo-server-build-progress')[0]);
        const screenshotTestProgress = mdc.linearProgress.MDCLinearProgress.attachTo($('#screenshot-test-progress')[0]);

        installNodeModuleProgress.progress = 0;
        demoServerBuildProgress.progress = 0;
        screenshotTestProgress.progress = 0;

        const submitButton = $('#submit')[0];

        const stdoutEl = $('#stdout')[0];
        const stderrEl = $('#stderr')[0];
        const otherEl = $('#other')[0];

        const appendAndScroll = (textarea, lines) => {
          const scrollTop = textarea.scrollTop;
          const scrollHeight = textarea.scrollHeight;
          const height = parseInt(window.getComputedStyle(textarea).height);
          const shouldScroll = scrollTop + height >= scrollHeight;

          textarea.value = lines.join('\n');
          if (shouldScroll) {
            textarea.scrollTop = textarea.scrollHeight;
          }
        };

        $('form').on('submit', (event) => {
          installNodeModuleProgress.determinate = false;
          demoServerBuildProgress.determinate = false;
          screenshotTestProgress.determinate = false;

          event.preventDefault();
          submitButton.disabled = true;

          const stdoutLines = [];
          const stderrLines = [];
          const otherLines = [];

          let interval = setInterval(() => {
            appendAndScroll(stdoutEl, stdoutLines);
            appendAndScroll(stderrEl, stderrLines);
            appendAndScroll(otherEl, otherLines);
          }, 250);

          const allDone = () => {
            clearInterval(interval);
            submitButton.disabled = false;
            installNodeModuleProgress.determinate = true;
            demoServerBuildProgress.determinate = true;
            screenshotTestProgress.determinate = true;
          };

          let last_response_len = false;

          $.ajax({
            method: 'POST',
            url: event.target.action,
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
              pr_number: $('#pr-number').val(),
            }),
            xhrFields: {
              onprogress: function(e) {
                let this_response, response = e.currentTarget.response;
                if (last_response_len === false) {
                  this_response = response;
                  last_response_len = response.length;
                }
                else {
                  this_response = response.substring(last_response_len);
                  last_response_len = response.length;
                }
                const lines = this_response.split(/[\n\r\f]+/g).filter((line) => Boolean(line));
                lines.forEach((line) => {
                  let parsed;
                  try {
                    parsed = JSON.parse(line);
                  } catch (e) {
                    console.warn('Error while parsing this response:');
                    console.warn(line);
                    console.error(e);
                    return;
                  }
                  if (parsed.stdout) {
                    stdoutLines.push(parsed.stdout);
                  } else if (parsed.stderr) {
                    stderrLines.push(parsed.stderr);
                  } else if (Number.isFinite(parsed.demoServerBuildPercentage)) {
                    demoServerBuildProgress.determinate = true;
                    demoServerBuildProgress.progress = parsed.demoServerBuildPercentage / 100;
                  } else if (parsed.eventType === 'browserStart' || parsed.eventType === 'browserFinish') {
                    const finishedBrowsers = parsed.browserList.filter((browser) => browser.endTime);
                    screenshotTestProgress.determinate = true;
                    screenshotTestProgress.progress = finishedBrowsers.length / parsed.browserList.length;
                    // TODO(acdvorak): Display pass/fail
                  } else if (Number.isFinite(parsed.installNodeModulePercentage)) {
                    installNodeModuleProgress.determinate = true;
                    installNodeModuleProgress.progress = parsed.installNodeModulePercentage / 100;
                  } else if (parsed.eventType === 'shuttingDownDemoServer') {
                    allDone();
                  } else {
                    otherLines.push(JSON.stringify(parsed, null, 2));
                  }
                });
              }
            },
          }).then((response) => allDone());
        });
      })();
    </script>
  </body>
</html>
