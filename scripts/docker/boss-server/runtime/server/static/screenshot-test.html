<!doctype html>
<html class="mdc-typography">
  <head>
    <meta charset="utf-8">
    <title>Screenshot Test - MDC-Web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.css">
    <link rel="stylesheet" href="node_modules/material-components-web/dist/material-components-web.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,600,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
      /* apply a natural box layout model to all elements, but allowing components to change */
      html {
        box-sizing: border-box;
      }
      *, *:before, *:after {
        box-sizing: inherit;
      }

      html,
      body {
        height: 100%;
      }

      th,
      td {
        text-align: left;
      }

      th {
        font-weight: 500;
      }

      .page {
        /* Hack to force the margin-top of .mdc-toolbar-fixed-adjust to collapse */
        border-top: 1px solid transparent;
      }

      .main {
        padding: 24px;
      }

      .top-section {
        display: flex;
      }

      .top-article {
        margin: 0 48px 48px 0;
      }

      .progress-article {
        min-width: 275px;
      }

      #pr-number {
        width: 8em;
      }

      .progress-label {
        margin-bottom: 8px;
        margin-top: 16px;
      }

      .progress-label__numbers {
        visibility: hidden;
      }

      .progress-label__numbers--visible {
        visibility: visible;
      }

      .output {
        margin: 24px 0;
      }

      #test-result-table th:not(:last-of-type),
      #test-result-table td:not(:last-of-type) {
        padding-right: 16px;
      }

      textarea {
        width: 100%;
        height: 15em;
        font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: small;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <header class="mdc-toolbar mdc-toolbar--fixed">
      <div class="mdc-toolbar__row">
        <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
          <span class="mdc-toolbar__title catalog-title">Screenshot Test</span>
        </section>
      </div>
    </header>

    <div class="page">
      <div class="mdc-toolbar-fixed-adjust"></div>

      <main class="main">
        <section>
          <div class="top-section">
            <article class="top-article">
              <h1 class="mdc-typography--title">GitHub Pull Request</h1>
              <form action="/github/pr">
                <div class="pr-form-field">
                  <div class="mdc-textfield mdc-textfield--box">
                    <input type="number"
                           min="1"
                           max="99999"
                           step="1"
                           size="6"
                           class="mdc-textfield__input"
                           aria-controls="name-validation-message"
                           id="pr-number"
                           name="pr_number"
                           value="1469"
                           required
                           autofocus>
                    <label for="pr-number" class="mdc-textfield__label">PR #</label>
                    <div class="mdc-textfield__bottom-line"></div>
                  </div>
                  <p class="mdc-textfield-helptext mdc-textfield-helptext--validation-msg"
                     id="name-validation-msg">
                    1-99999 required
                  </p>
                </div>
                <button type="submit" id="submit" class="mdc-button mdc-button--stroked">Start Screenshot Tests</button>
              </form>
            </article>

            <article class="top-article progress-article">
              <h1 class="mdc-typography--title">Progress</h1>

              <div class="progress-bucket">
                <div class="mdc-typography--body1 progress-label">
                  Node Module Installation
                  <i class="progress-label__numbers">(<i class="progress-label__percentage">0</i>%)</i>
                </div>
                <div role="progressbar" class="mdc-linear-progress" id="node-module-progress">
                  <div class="mdc-linear-progress__buffering-dots"></div>
                  <div class="mdc-linear-progress__buffer"></div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                </div>
              </div>

              <div class="progress-bucket">
                <div class="mdc-typography--body1 progress-label">
                  Demo Server Build
                  <i class="progress-label__numbers">(<i class="progress-label__percentage">0</i>%)</i>
                </div>
                <div role="progressbar" class="mdc-linear-progress" id="demo-server-build-progress">
                  <div class="mdc-linear-progress__buffering-dots"></div>
                  <div class="mdc-linear-progress__buffer"></div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                </div>
              </div>

              <div class="progress-bucket">
                <div class="mdc-typography--body1 progress-label">
                  Screenshot Tests
                  <i class="progress-label__numbers">(<i class="progress-label__remaining">0</i> of <i class="progress-label__total">0</i> remaining)</i>
                </div>
                <div role="progressbar" class="mdc-linear-progress" id="screenshot-test-progress">
                  <div class="mdc-linear-progress__buffering-dots"></div>
                  <div class="mdc-linear-progress__buffer"></div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                  <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                    <span class="mdc-linear-progress__bar-inner"></span>
                  </div>
                </div>
              </div>
            </article>

            <article class="top-article" style="display: none">
              <h1 class="mdc-typography--title">Screenshot Test Results</h1>

              <table id="test-result-table"></table>
            </article>
          </div>

          <div class="outputs">
            <div class="output">
              <h2 class="mdc-typography--subheading2">stdout</h2>
              <textarea readonly id="stdout"></textarea>
            </div>

            <div class="output">
              <h2 class="mdc-typography--subheading2">stderr</h2>
              <textarea readonly id="stderr"></textarea>
            </div>

            <div class="output">
              <h2 class="mdc-typography--subheading2">other</h2>
              <textarea readonly id="other"></textarea>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
    <script src="node_modules/material-components-web/dist/material-components-web.js"></script>
    <script>
      (() => {
        $('.mdc-button').each((i, button) => mdc.ripple.MDCRipple.attachTo(button));
        $('.mdc-textfield').each((i, textField) => mdc.textfield.MDCTextfield.attachTo(textField));

        const $installNodeModuleProgress = $('#node-module-progress');
        const installNodeModuleProgress = mdc.linearProgress.MDCLinearProgress.attachTo($installNodeModuleProgress[0]);
        const $demoServerBuildProgress = $('#demo-server-build-progress');
        const demoServerBuildProgress = mdc.linearProgress.MDCLinearProgress.attachTo($demoServerBuildProgress[0]);
        const $screenshotTestProgress = $('#screenshot-test-progress');
        const screenshotTestProgress = mdc.linearProgress.MDCLinearProgress.attachTo($screenshotTestProgress[0]);

        function setInstallNodeModuleProgress(percentage) {
          installNodeModuleProgress.progress = percentage / 100;
          $installNodeModuleProgress.closest('.progress-bucket')
            .find('.progress-label__numbers').addClass('progress-label__numbers--visible')
              .find('.progress-label__percentage').text(percentage)
          ;
        }
        function setDemoServerBuildProgress(percentage) {
          demoServerBuildProgress.progress = percentage / 100;
          $demoServerBuildProgress.closest('.progress-bucket')
            .find('.progress-label__numbers').addClass('progress-label__numbers--visible')
              .find('.progress-label__percentage').text(percentage)
          ;
        }
        function setScreenshotTestProgress(browsers) {
          const finishedBrowsers = browsers.filter((browser) => browser.endTime);
          const numTotal = browsers.length;
          const numFinished = finishedBrowsers.length;
          const numRemaining = numTotal - numFinished;
          screenshotTestProgress.progress = numTotal === 0 ? 0 : (numFinished / numTotal);
          $screenshotTestProgress.closest('.progress-bucket')
            .find('.progress-label__numbers').addClass('progress-label__numbers--visible')
              .find('.progress-label__remaining').text(numRemaining)
              .end()
              .find('.progress-label__total').text(numTotal)
          ;
          const $testResultTable = $('#test-result-table');

          if (browsers.length) {
            $testResultTable.empty().html(`
              <thead>
                <th>Browser/OS/Device</th>
                <th>Result</th>
              </thead>
              <tbody>
              ${browsers.map((browser) => `
                <tr>
                  <td>${browser.description}</td>
                  <td>${browser.endTime ? `${browser.testResult}!` : 'Running...'}</td>
                </tr>
              `).join('\n')}
              </tbody>
            `);
            $testResultTable.closest('.top-article').show();
          } else {
            $testResultTable.closest('.top-article').hide();
          }
        }

        setInstallNodeModuleProgress(0);
        setDemoServerBuildProgress(0);
        setScreenshotTestProgress([]);

        const submitButton = $('#submit')[0];

        const stdoutEl = $('#stdout')[0];
        const stderrEl = $('#stderr')[0];
        const otherEl = $('#other')[0];

        const appendAndScroll = (textarea, lines) => {
          const scrollTop = textarea.scrollTop;
          const scrollHeight = textarea.scrollHeight;
          const height = parseInt(window.getComputedStyle(textarea).height);
          const shouldScroll = scrollTop + height >= scrollHeight;

          textarea.value = lines.join('\n');
          if (shouldScroll) {
            textarea.scrollTop = textarea.scrollHeight;
          }
        };

        $('form').on('submit', (event) => {
          installNodeModuleProgress.determinate = false;
          demoServerBuildProgress.determinate = false;
          screenshotTestProgress.determinate = false;

          event.preventDefault();
          submitButton.disabled = true;

          const stdoutLines = [];
          const stderrLines = [];
          const otherLines = [];

          let interval = setInterval(() => {
            appendAndScroll(stdoutEl, stdoutLines);
            appendAndScroll(stderrEl, stderrLines);
            appendAndScroll(otherEl, otherLines);
          }, 250);

          const allDone = () => {
            clearInterval(interval);
            submitButton.disabled = false;
            installNodeModuleProgress.determinate = true;
            demoServerBuildProgress.determinate = true;
            screenshotTestProgress.determinate = true;
          };

          let last_response_len = false;

          $.ajax({
            method: 'POST',
            url: event.target.action,
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
              pr_number: $('#pr-number').val(),
            }),
            xhrFields: {
              onprogress: function(e) {
                let this_response, response = e.currentTarget.response;
                if (last_response_len === false) {
                  this_response = response;
                  last_response_len = response.length;
                }
                else {
                  this_response = response.substring(last_response_len);
                  last_response_len = response.length;
                }
                const lines = this_response.split(/[\n\r\f]+/g).filter((line) => Boolean(line));
                lines.forEach((line) => {
                  let parsed;
                  try {
                    parsed = JSON.parse(line);
                  } catch (e) {
                    console.warn('Error while parsing this response:');
                    console.warn(line);
                    console.error(e);
                    return;
                  }
                  if (parsed.stdout) {
                    stdoutLines.push(parsed.stdout);
                  } else if (parsed.stderr) {
                    stderrLines.push(parsed.stderr);
                  } else if (Number.isFinite(parsed.installNodeModulePercentage)) {
                    installNodeModuleProgress.determinate = true;
                    setInstallNodeModuleProgress(parsed.installNodeModulePercentage);
                  } else if (Number.isFinite(parsed.demoServerBuildPercentage)) {
                    demoServerBuildProgress.determinate = true;
                    setDemoServerBuildProgress(parsed.demoServerBuildPercentage);
                  } else if (parsed.eventType === 'browserStart' || parsed.eventType === 'browserFinish') {
                    screenshotTestProgress.determinate = true;
                    setScreenshotTestProgress(parsed.browserList);
                    // TODO(acdvorak): Display pass/fail
                  } else if (parsed.eventType === 'shuttingDownDemoServer') {
                    allDone();
                  } else {
                    otherLines.push(JSON.stringify(parsed));
                  }
                });
              }
            },
          }).then((response) => allDone());
        });
      })();
    </script>
  </body>
</html>
